
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 6 - Sequential Matching Mode</title>
    <style>




body { 
    background: linear-gradient(to bottom, #5c3a00, #2a1500);
    font-family: 'Creepster', cursive;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    margin: 0;
    color: orange;
    text-align: center;
}

.header {
    margin-top: 15px;
    margin-bottom: 10px;
}

.header h1 {
    font-size: 64px;
    color: orange;
    text-shadow: 2px 2px 5px black;
    margin: bottom 10px;
}

.info-container {
    display: flex;
    justify-content: center;
    gap: 100px;
    font-size: 28px;
    text-shadow: 1px 1px 3px black;
}

.sequence-container {
    margin-top: 10px;
    margin-bottom: 20px;
    font-size: 20px;
    color: #ffb347;
}

.sequence-box {
    font-size: 24px;
    color: #ff6347;
    font-weight: bold;
    margin-top: px;
}

.grid-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 10px;
    margin-bottom: 40px;
}

.grid { 
    display: grid; 
    grid-template-columns: repeat(4, 100px); 
    gap: 15px;
}

.card {
    width: 100px;
    height: 150px;
    background-color: gray;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    position: relative;
    border-radius: 10px;
    transition: transform 0.6s;
    transform-style: preserve-3d;
    box-shadow: 0 4px 8px rgba(0,0,0,0.4);
}

.card img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    display: none;
    border-radius: 10px;
}

.revealed {
    background-color: black !important;
}
.revealed img {
    display: block;
}

.highlight {
    font-weight: bold;
    color: #ff6347;
}

.video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
}

body {
    background: linear-gradient(to bottom, #5c3a00, #2a1500);
    font-family: 'Creepster', cursive;
    margin: 0;
    padding: 0;
    color: orange;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    text-align: center;
}

.header {
    margin-top: 40px;
    margin-bottom: 20px;
}

.header h1 {
    font-size: 72px;
    text-shadow: 4px 4px 8px black;
    color: orange;
}

.info-container {
    display: flex;
    justify-content: center;
    gap: 120px;
    font-size: 32px;
    text-shadow: 2px 2px 4px black;
    margin-bottom: 10px;
}

.sequence-container {
    margin-top: -60px;
    margin-bottom: 20px;
    font-size: 26px;
    color: #ffcc66;
    text-shadow: 1px 1px 2px black;
}


.overlay {
      position: fixed; top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.85);
      display: flex; justify-content: center; align-items: center;
      z-index: 10000; cursor: pointer;
    }
    .overlay h2 {
      color: #ff6347; font-size: 48px;
      text-shadow: 2px 2px 4px black;
    }
.sequence-box {
    font-size: 28px;
    color: #ff6347;
    font-weight: bold;
    margin-top: 10px;
}

.grid-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 60px;
}

.grid {
    display: grid;
    grid-template-columns: repeat(4, 130px);
    gap: 25px;
}

.card {
    width: 130px;
    height: 180px;
    background-color: #555;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 12px;
    transition: transform 0.6s;
    transform-style: preserve-3d;
    box-shadow: 0 6px 12px rgba(0,0,0,0.5);
}

.card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
    border-radius: 12px;
}

.revealed {
    background-color: black !important;
}
.revealed img {
    display: block;
}

.highlight {
    font-weight: bold;
    color: #ff6347;
}

.video-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
}

.card {
    width: 130px;
    height: 180px;
    perspective: 1000px;
    cursor: pointer;
}

.card-face {
    width: 100%;
    height: 100%;
    position: absolute;
    backface-visibility: hidden;
    border-radius: 12px;
}

.card-front {
    background-color: #555;
}

.card-back {
    transform: rotateY(180deg);
    overflow: hidden;
}

.card.revealed {
    transform: rotateY(180deg);
}

.card {
    transition: transform 0.6s;
    transform-style: preserve-3d;
    position: relative;
}
 @media (max-width: 600px) {
  .header h1 {
    font-size: 35px;
  }
   .info-container {
    font-size: 19px;
    gap: 17px;          /* 调大间距 */
    flex-direction: row; /* 横排 */
    justify-content: center; /* 居中 */
    align-items: center; /* 垂直居中 */
   }
  .sequence-container {
    font-size: 18px;
  }
  .card {
    width: 70px;
    height: 100px;
  }
  .grid {
    grid-template-columns: repeat(4, 70px);
    gap: 10px;
  }
  #startBtn {
    padding: 12px 40px;
    font-size: 20px;
  }
  /* 可选：隐藏背景视频和音乐 */
  /* .video-background {
    display: none;
  } */
   
  #bgMusic {
    display: none;
  }
}


#backBtn {
      margin: 0 auto 40px auto;
      display: block;
      padding: 10px 25px;
      font-size: 18px;
      background-color: #ff6347;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(255, 99, 71, 0.7);
      transition: background-color 0.3s ease;
    }
    #backBtn:hover {
      background-color: #e5533d;
    }

</style>

</head>
<body>



<!-- Overlay for game rules and start button -->
<div id="startOverlay" class="overlay" style="display:flex; flex-direction: column; background: rgba(0,0,0,0.9); cursor: default; z-index: 10000;">
  <div style="max-width: 600px; color: #ffcc33; font-size: 24px; line-height: 1.5; text-align: left;  padding: 20px; margin-bottom: 20px; ">
    <h2 style="text-align: center; margin-bottom: 20px;">Game Rules</h2>
    <p>1. You have 90 seconds to complete 3 rounds.</p>
    <p>2. Match the card pairs in order for each round.</p>
    <p>3. All cards will be shown for 10 seconds before hiding.</p>
    <p>4. The game ends when time runs out.</p>
    <p>5. Good luck and start the challenge!</p>
  </div>
  <button id="startBtn" style="padding: 15px 50px; font-size: 24px; font-weight: bold; color: white; background-color: #ff6347; border: none; border-radius: 8px; cursor: pointer; align-self: center;">
    Click Start
  </button>
</div>


    <audio id="bgMusic" src="Sound\background music.mp3" loop autoplay></audio>
    <audio id="flipSound" src="Sound/flip.mp3"></audio>
    <audio id="matchSound" src="Sound/match.mp3"></audio>
    
    
    <video class="video-background" autoplay loop muted playsinline
       style="position:fixed;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:-1;">
  <source src="background.mp4" type="video/mp4">
</video>

    
    <div class="header">
        <h1>Level 6-Sequential Matching Mode</h2>
        <div class="info-container">
            <p>Current Round: <span id="roundNumber">1</span> / 3</p>
            <p>Time Left: <span id="timer">90</span> </p>
        </div>
    </div>
    

    <div class="sequence-container">
        <p>System Hint - Match in Order：</p>
        <div id="sequenceDisplay" class="sequence-box"></div>
      
    </div>
        
        <div class="grid-container">
            
            <div id="grid" class="grid"></div>
        </div>

         <button id="backBtn">BACK </button>

        <script>

           const flipSound = document.getElementById("flipSound");
const matchSound = document.getElementById("matchSound");

const grid = document.getElementById("grid");
const sequenceDisplay = document.getElementById("sequenceDisplay");
const roundNumberDisplay = document.getElementById("roundNumber");
const timerDisplay = document.getElementById("timer");

// 原本每轮设置时间的数组，可以保留 pairs 设置，但忽略 time
let rounds = [
  { pairs: [[1, 2], [3, 4]] },
  { pairs: [[1, 2], [3, 4], [5, 6], [7, 8]] },
  { pairs: [[1, 2], [3, 4], [5, 6], [7, 8], [9, 10],[11, 12]] }
];

let currentRound = 0;
let totalTimeLimit = 90; // 总时间
let totalTimeLeft = totalTimeLimit;
let totalTimeUsed = 0;

let sequence = [];
let shuffledCards = [];
let selectedCards = [];
let correctIndex = 0;
let totalSteps = 0;
let correctMatches = 0;
let wrongAttempts = 0;
let reactionTime = 0;
let lastClickTime = null;
let timer = null;
let isProcessing = false;
let timerRunning = false;

localStorage.setItem('currentLevel', 'Level-6'); 


function startRound() {
  roundNumberDisplay.textContent = currentRound + 1;
  sequence = [...rounds[currentRound].pairs].sort(() => Math.random() - 0.5);
  shuffledCards = sequence.flat().sort(() => Math.random() - 0.5);
  selectedCards = [];
  correctIndex = 0;
  grid.innerHTML = "";
  shuffledCards.forEach(num => createCard(num));
  displaySequence();
}

const backBtn = document.getElementById("backBtn");

backBtn.addEventListener("click", () => {
  const confirmLeave = confirm("Are you sure you want to return to the level selection page? Your current game progress will not be saved.");
  if (confirmLeave) {
    window.location.href = "Level section.html"; // 替换为你的主页地址
  }
});



function displaySequence() {
  sequenceDisplay.innerHTML = sequence.map(pair => `<span class="highlight">(${pair[0]}, ${pair[1]})</span>`).join(" → ");
  showAllCards();

  setTimeout(() => {
    hideCards();
    startTimer();  // 10秒展示后，隐藏卡片，再启动计时器
  }, 5000);
}


function showAllCards() {
  document.querySelectorAll(".card").forEach(card => card.classList.add("revealed"));
}

function hideCards() {
  document.querySelectorAll(".card").forEach(card => card.classList.remove("revealed"));
  sequenceDisplay.innerHTML = "Match the cards by flipping them in the correct sequence.！";
}

function createCard(number) {
  const card = document.createElement("div");
  card.classList.add("card");
  card.dataset.value = number;

  const front = document.createElement("div");
  front.classList.add("card-face", "card-front");

  const back = document.createElement("div");
  back.classList.add("card-face", "card-back");

  const img = document.createElement("img");
  img.src = `./images/${number}.png`;
  img.alt = `Number ${number}`;

  back.appendChild(img);
  card.appendChild(front);
  card.appendChild(back);
  grid.appendChild(card);

  card.onclick = function () {
    if (!this.classList.contains("revealed") && selectedCards.length < 2) {
      flipCard(this);
    }
  };
}

function flipCard(card) {
  if (isProcessing || selectedCards.includes(card)) return;

  card.classList.add("revealed");
  flipSound.currentTime = 0;
  flipSound.play();

  selectedCards.push(card);

  if (selectedCards.length === 1) {
    lastClickTime = Date.now();
  }

  if (selectedCards.length === 2) {
    isProcessing = true;
    totalSteps++;
    let first = selectedCards[0].dataset.value;
    let second = selectedCards[1].dataset.value;
    let correctPair = sequence[correctIndex];

    let currentClickTime = Date.now();
    let reactionDuration = (currentClickTime - lastClickTime) / 1000;
    reactionTime += reactionDuration;

    if ((first == correctPair[0] && second == correctPair[1]) || (first == correctPair[1] && second == correctPair[0])) {
      correctMatches++;
      matchSound.currentTime = 0;
      matchSound.play();

      correctIndex++;
      selectedCards = [];
      isProcessing = false;

     if (correctIndex === sequence.length) {
  setTimeout(() => {
    if (currentRound < rounds.length - 1) {
      currentRound++;
      startRound();
    } else {
      endGame();
    }
  }, 600); // 等待 600ms 翻牌动画完成再进入下一轮
}

    } else {
      wrongAttempts++;
      setTimeout(() => {
        selectedCards.forEach(card => card.classList.remove("revealed"));
        selectedCards = [];
        isProcessing = false;
      }, 600);
    }
  }
}

function startTimer() {
  if (timerRunning) return; // 避免重复启动计时器
  timerRunning = true;

  timer = setInterval(() => {
    totalTimeLeft--;
    timerDisplay.textContent = totalTimeLeft;
    if (totalTimeLeft <= 0) {
      clearInterval(timer);
      timerRunning = false;
      endGame();
    }
  }, 1000);
}

function startTimer() {
  if (timerRunning) return; // 避免重复启动计时器
  timerRunning = true;

  timer = setInterval(() => {
    totalTimeLeft--;
    timerDisplay.textContent = totalTimeLeft;
    if (totalTimeLeft <= 0) {
      clearInterval(timer);
      timerRunning = false;
      endGame();
    }
  }, 1000);
}

function endGame() {
  clearInterval(timer);

  const timeUsed = totalTimeLimit - totalTimeLeft;
  const formattedTime = formatSecondsToMMSS(timeUsed);
  console.log("endGame called, timeUsed:", timeUsed, "formattedTime:", formattedTime);

  const accuracy = correctMatches / totalSteps || 0;
  const score = Math.max(50, 100 - wrongAttempts * 5);
  const note = wrongAttempts <= 1 
      ? "very excellent" 
      : wrongAttempts <= 3 
      ? "good" 
      : "Need to strengthen";

  const avgReaction = reactionTime > 0 ? (reactionTime / correctMatches) : 0;

  const gameData = {
    level: "Level 6 - Sequential Matching Mode",
    levelId: "legendary",
    timeUsed,
    formattedTime,
    wrongAttempts,
    accuracy: parseFloat(accuracy.toFixed(2)),
    score,
    note,
    totalSteps,
    correctMatches,
    reactionTime: parseFloat(avgReaction.toFixed(2))
  };

  console.log("Game data to save:", gameData);

  saveGameResults(gameData);

  window.location.href = "memory_analysis.html";
}



// 辅助函数 - 秒转 mm:ss 格式
function formatSecondsToMMSS(seconds) {
    const m = Math.floor(seconds / 60).toString().padStart(2, "0");
    const s = (seconds % 60).toString().padStart(2, "0");
    return `${m}:${s}`;
}


function saveGameResults(gameData) {
  const abilities = generateAbilitiesFrom(gameData);

  // 读取已有数据
  let existingResult = JSON.parse(localStorage.getItem("memoryGameResult"));

  if (!existingResult) {
    existingResult = {
      overallScore: gameData.score,
      abilities: abilities,
      levels: []
    };
  }

  // 检查是否已有当前关卡数据，更新或添加
  const idx = existingResult.levels.findIndex(lvl => lvl.levelId === gameData.levelId);
  const newLevelData = {
    level: gameData.level,
    levelId: gameData.levelId,
    time: gameData.timeUsed,
    formattedTime: gameData.formattedTime,
    errors: gameData.wrongAttempts,
    accuracy: gameData.accuracy,
    score: gameData.score,
    note: gameData.note
  };

  if (idx > -1) {
    existingResult.levels[idx] = newLevelData; // 更新该关卡数据
  } else {
    existingResult.levels.push(newLevelData);  // 添加新关卡数据
  }

  // 更新整体分数，举例取所有关卡平均分
  const totalScore = existingResult.levels.reduce((acc, lvl) => acc + lvl.score, 0);
  existingResult.overallScore = Math.round(totalScore / existingResult.levels.length);

  // abilities 你可以根据需要更新，暂时用最后一次的
  existingResult.abilities = abilities;

  // 保存回 localStorage
  localStorage.setItem("memoryGameResult", JSON.stringify(existingResult));

  // 保存单次游戏详细数据（可选）
  localStorage.setItem("memoryGameData", JSON.stringify(gameData));

  // 更新最佳时间
  updateBestTime(gameData.levelId, gameData.formattedTime);
}



function generateAbilitiesFrom(gameData) {
  const {
    accuracy = 0,
    reactionTime = 0,
    wrongAttempts = 0,
    totalSteps = 1,
    timeUsed = 90,
    correctMatches = 0
  } = gameData;

  function calculateShortTermScore(totalSteps, wrongAttempts, correctMatches) {
    if (correctMatches === 0) return 0;
    const earlySteps = Math.min(6, totalSteps); // First 6 steps (first 3 pairs)
    const earlyErrorRate = Math.min(1, wrongAttempts / earlySteps);
    const score = Math.max(40, 100 - earlyErrorRate * 100);
    return Math.round(score);
  }

  return {
    shortTerm: calculateShortTermScore(totalSteps, wrongAttempts, correctMatches),
    attention: Math.round(accuracy * 100),
    reaction: Math.max(0, 100 - reactionTime * 20),
    sequence: totalSteps <= 14 ? 80 : 50,
    resistance: Math.max(0, 100 - wrongAttempts * 4),
    endurance: Math.max(0, Math.min(100, (1 - (timeUsed / 45)) * 100))
  };
}

function calculateAverage(prev, current) {
  if (!prev) return current;
  return Math.round((prev + current) / 2);
}



const startOverlay = document.getElementById("startOverlay");
const startBtn = document.getElementById("startBtn");

startBtn.addEventListener("click", () => {
  startOverlay.style.display = "none";
  startRound();
  // 开始计时器时，要判断计时器是否已经在运行，避免多次启动
  if (!timerRunning) startTimer();
});

// 更新 localStorage 中的最佳时间
function updateBestTime(levelId, newTime) {
  const bestTimesKey = "bestTimes"; // 存储所有关卡的最好时间，格式：{ levelId: "mm:ss", ... }
  let bestTimes = JSON.parse(localStorage.getItem(bestTimesKey)) || {};

  const prevBest = bestTimes[levelId];
  if (!prevBest || timeToSeconds(newTime) < timeToSeconds(prevBest)) {
    bestTimes[levelId] = newTime;
  }
  localStorage.setItem(bestTimesKey, JSON.stringify(bestTimes));
}

// 工具函数，时间字符串转秒数
function timeToSeconds(timeStr) {
  if (!timeStr || timeStr === '--:--') return Infinity;
  const [minutes, seconds] = timeStr.split(':').map(Number);
  return minutes * 60 + seconds;
}


function setupInitialGrid() {
  roundNumberDisplay.textContent = currentRound + 1;
  sequence = [...rounds[currentRound].pairs];
  shuffledCards = sequence.flat().sort(() => Math.random() - 0.5);
  grid.innerHTML = "";

  shuffledCards.forEach(num => {
    const card = document.createElement("div");
    card.classList.add("card");
    card.dataset.value = num;

    const front = document.createElement("div");
    front.classList.add("card-face", "card-front");

    const back = document.createElement("div");
    back.classList.add("card-face", "card-back");

    const img = document.createElement("img");
    img.src = `./images/${num}.png`;
    img.alt = `Number ${num}`;

    back.appendChild(img);
    card.appendChild(front);
    card.appendChild(back);
    grid.appendChild(card);
  });
}
window.addEventListener("DOMContentLoaded", () => {
  setupInitialGrid();  // 显示静态卡片
});

// localStorage.clear();  // 清空所有的 localStorage 数据
    </script>

    